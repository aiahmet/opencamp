# AGENTS.md

## Purpose
- This file guides agentic coding tools working in this repo.
- Follow these instructions before making edits or running commands.

## CRITICAL: Do NOT Run Dev Server
- NEVER run `npm run dev` or `npx convex dev` under any circumstances.
- The dev server is managed separately and running it will cause lock conflicts.
- This is a hard rule - do not attempt to verify changes by starting the dev server.

## Project Snapshot
- Framework: Next.js 16 (App Router) with React 19 and TypeScript.
- Auth: Clerk with Next.js 16 proxy support.
- Backend: Convex (convex/ directory, generated types in convex/_generated).
- UI: Tailwind CSS v4 + shadcn/ui (custom claymorphism theme).
- Linting: eslint-config-next (core-web-vitals + typescript).

## Key Directories
- app/: App Router routes (page.tsx, layout.tsx, sign-in, sign-up, dashboard).
- components/: app-level React components.
- components/ui: shadcn/ui components.
- middleware.ts: Next.js middleware for Clerk authentication.
- convex/: Convex schema and server functions.
- public/: static assets.

## Build, Lint, Test Commands
- Install: `npm install`
- Dev server: `npm run dev`
- Build: `npm run build`
- Start (prod): `npm run start`
- Lint: `npm run lint`
- Convex dev: `npx convex dev`

### Tests
- Test framework: Vitest with React Testing Library
- Run all tests: `npm test` (single run)
- Run tests in watch mode: `npm run test:watch`
- Run tests with coverage: `npm run test:coverage`
- Single test file: `npx vitest run <path-to-test-file>`
- Single test pattern: `npx vitest run -t "test name"`
- Coverage thresholds: 70% lines, functions, statements; 60% branches

## Environment Variables
- Local env lives in `.env.local` (do not commit secrets).
- **NEVER modify `.env.local` to replace real values with placeholder values.** The `.env.local` file contains actual working configuration.
- Public vars must be prefixed with `NEXT_PUBLIC_`.
- Convex auth uses `AUTH_SECRET` and must be set in the Convex dashboard.
- Example placeholders are in `.env.local.example`.
- Avoid logging or printing secrets in console output.
- `WHITEBOARD_MAX_HISTORY_SIZE` controls the undo history limit (default: 1000).

## Auth and Middleware Notes
- Next.js 16 uses `middleware.ts` for Clerk authentication.
- Clerk expects `clerkMiddleware()` in the middleware file.
- Route protection lives in `middleware.ts`.
- If auth errors mention middleware, verify matcher configuration.
- The middleware runtime is Edge; avoid Node.js-specific APIs.

## Convex + Clerk Integration
- Convex schema lives in `convex/schema.ts`.
- Convex auth config lives in `convex/auth.config.ts`.
- Convex type generation writes to `convex/_generated/`.
- Clerk client hooks live in `@clerk/nextjs`.
- Clerk server utilities live in `@clerk/nextjs/server`.
- If Convex complains about `AUTH_SECRET`, set it in the Convex dashboard.

## Code Style Guidelines

### Formatting
- Use 2-space indentation.
- Keep semicolons.
- Prefer double quotes in TS/TSX imports and strings.
- Match the existing style in the file you edit.
- Keep lines readable; avoid very long className strings when possible.

### Imports
- Order imports: external packages, then absolute imports, then relative.
- Keep imports grouped by blank lines.
- Prefer named imports over default when available.

### TypeScript and Types
- Avoid `any` and unsafe type assertions.
- Prefer inference for obvious types; annotate when ambiguous.
- Use `type` aliases for props and simple shapes.
- Use `ReactNode` for children when needed.
- Do not edit `convex/_generated` files (generated by Convex).

### Naming Conventions
- Components: PascalCase (e.g., `ConvexClientProvider`).
- Hooks: `useX` naming.
- Variables/functions: camelCase.
- Constants: UPPER_SNAKE_CASE if truly constant.
- Files in `src/app` follow Next.js conventions (`page.tsx`, `layout.tsx`).

### React and Next.js Patterns
- Prefer server components by default; add `'use client'` only when needed.
- Only call Clerk hooks (`useUser`, `useAuth`) in client components.
- Use `next/link` for internal navigation.
- Keep layout chrome (header, providers) in `app/layout.tsx`.
- Put route-level UI in `app/<route>/page.tsx`.
- Avoid using `useEffect` for data fetching unless required.

### Data Fetching and State
- In client components, handle loading and empty states.
- Use Convex `useQuery` in client components only.
- Use server functions in `convex/` for data access.
- Avoid fetching in layout unless necessary.

### Error Handling
- Handle `isLoaded` before reading Clerk user/session data.
- Show loading and empty states in client components.
- For server errors, throw `Error` with useful messages.
- Avoid silent failures; log or surface errors when appropriate.

### Styling
- Use Tailwind CSS utility classes for layout and spacing.
- Use shadcn/ui components from `components/ui` for consistency.
- Theme variables live in `app/globals.css`.
- When modifying theme variables, keep the existing variable names.
- Prefer CSS variables over hard-coded colors in new components.
- Avoid inline styles unless necessary for dynamic values.

### Accessibility
- Use semantic HTML (header, main, section, button).
- Provide accessible button labels and link text.
- Ensure focus states are visible (Tailwind focus-visible utilities).

### Comments
- Never write useless long comments.
- Keep comments very concise.
- Only add comments when necessary to explain complex logic or non-obvious behavior.

## Linting Rules
- ESLint is configured via `eslint.config.mjs`.
- It includes Next.js core web vitals and TypeScript rules.
- Default ignores include `.next/`, `out/`, `build/`, and `next-env.d.ts`.
- Keep lint clean before merging changes.

## Generated and Vendor Files
- Do not edit `.next/` or `convex/_generated/` manually.
- Regenerate Convex types by running `npx convex dev`.
- Do not edit `node_modules/`.

## Cursor/Copilot Rules
- No `.cursor/rules/`, `.cursorrules`, or `.github/copilot-instructions.md` found.
- If you add rules later, update this file accordingly.

## Common Tasks
- Add shadcn component: `npx shadcn@latest add <component>`.
- Add a new route: create `app/<route>/page.tsx`.
- Protect routes: update matchers in `middleware.ts`.
- Update theme: edit CSS variables in `app/globals.css`.
- Add Convex function: create a file in `convex/` and run `npx convex dev`.
- Update dependencies: edit `package.json` and keep `package-lock.json` in sync.

## Practical Tips
- Keep secrets out of git; use `.env.local` for local-only values.
- After auth changes, re-run `npm run dev` to reload env.
- If build errors mention Clerk, verify `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`.
- If Convex errors mention AUTH_SECRET, update it in the Convex dashboard.
- `SETUP_COMPLETE.md` contains detailed setup notes.
